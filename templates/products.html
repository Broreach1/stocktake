{% extends "layout.html" %}
{% block content %}

<div class="container">
    <h1>Products</h1>

    <!-- Buttons -->
    <div class="products-actions">
        <button id="addProductBtn">Add Product</button>
        <button id="importBtn">Import from Excel</button>
    </div>

    <script>
        document.getElementById('importBtn').addEventListener('click', () => {
            window.location.href = "{{ url_for('import_products') }}";
        });
    </script>

    <!-- Products Table -->
    <div class="table-wrapper">
        <table id="productTable">
            <thead>
                <tr>
                    <th>ID</th>
                    {% if session.get('role') == 'admin' %}
                        <th>User ID</th>
                    {% endif %}
                    <th>SKU</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Cost</th>
                    <th>Qty</th>
                    <th>Min Qty</th>
                    <th>Barcode</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for p in products %}
                <tr data-product='{{ p|tojson }}' 
                    {% if (p.qty or 0) < (p.min_qty or 0) %}class="low-stock"{% endif %}>
                    <td>{{ p.id }}</td>
                    {% if session.get('role') == 'admin' %}
                        <td>{{ p.user_id }}</td>
                    {% endif %}
                    <td>{{ p.sku }}</td>
                    <td>{{ p.name }}</td>
                    <td>
                        {% if p.price is not none %}
                            {{ "%.2f"|format(p.price) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if p.cost is not none %}
                            {{ "%.2f"|format(p.cost) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ p.qty or 0 }}</td>
                    <td>{{ p.min_qty or 0 }}</td>
                    <td>{{ p.barcode }}</td>
                    <td>
                        <button class="editBtn">Edit</button>
                        <button class="deleteBtn">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div id="productModal">
    <h2 id="modalTitle">Add Product</h2>
    <input type="hidden" id="productId">
    <div class="modal-inputs">
        <label>SKU:</label><input type="text" id="sku">
        <label>Name:</label><input type="text" id="name">
        <label>Price:</label><input type="number" step="0.01" id="price">
        <label>Cost:</label><input type="number" step="0.01" id="cost">
        <label>Qty:</label><input type="number" id="qty">
        <label>Min Qty:</label><input type="number" id="min_qty">
        <label>Barcode:</label><input type="text" id="barcode">
    </div>
    <div class="modal-actions">
        <button id="saveProduct">Save</button>
        <button id="closeModal">Cancel</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
    const modal=document.getElementById('productModal');
    const productIdInput=document.getElementById('productId');

    function openModal(product=null){
        modal.style.display='block';
        if(product){
            document.getElementById('modalTitle').innerText='Edit Product';
            productIdInput.value=product.id;
            ['sku','name','price','cost','qty','min_qty','barcode'].forEach(id=>{
                document.getElementById(id).value=product[id] ?? '';
            });
        } else {
            document.getElementById('modalTitle').innerText='Add Product';
            productIdInput.value='';
            ['sku','name','price','cost','qty','min_qty','barcode'].forEach(id=>{
                document.getElementById(id).value='';
            });
        }
    }

    document.getElementById('addProductBtn').addEventListener('click',()=>openModal());
    document.getElementById('closeModal').addEventListener('click',()=>modal.style.display='none');

    document.getElementById('saveProduct').addEventListener('click',()=>{
        const id=productIdInput.value;
        const payload={
            sku:document.getElementById('sku').value,
            name:document.getElementById('name').value,
            price:parseFloat(document.getElementById('price').value) || null,
            cost:parseFloat(document.getElementById('cost').value) || null,
            qty:parseInt(document.getElementById('qty').value) || 0,
            min_qty:parseInt(document.getElementById('min_qty').value) || 0,
            barcode:document.getElementById('barcode').value
        };
        const url=id?'/api/products/update':'/api/products/add';
        if(id) payload.id=id;
        fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(res=>res.json())
        .then(data=>{
            if(data.success) location.reload();
            else alert('Error saving product');
        });
    });

    document.querySelectorAll('.editBtn').forEach(btn=>{
        btn.addEventListener('click',e=>{
            const product=JSON.parse(e.target.closest('tr').dataset.product);
            openModal(product);
        });
    });

    document.querySelectorAll('.deleteBtn').forEach(btn=>{
        btn.addEventListener('click',e=>{
            const product=JSON.parse(e.target.closest('tr').dataset.product);
            if(confirm(`Delete ${product.name}?`)){
                fetch(`/api/products/delete/${product.id}`,{method:'DELETE'})
                .then(r=>r.json())
                .then(res=>{if(res.success) location.reload();});
            }
        });
    });
});
</script>

<style>
/* Buttons container */
.products-actions {
    margin-bottom: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

/* Table wrapper */
.table-wrapper {
    overflow-x: auto;
}

/* Modal styling */
#productModal {
    display: none;
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background:#fff;
    padding:20px;
    border-radius:10px;
    box-shadow:0 6px 20px rgba(0,0,0,0.2);
    z-index:1000;
    max-width:400px;
    width: 90%;
}

.modal-inputs {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.modal-actions {
    margin-top: 12px;
    display: flex;
    gap: 10px;
}

/* Low stock row */
.low-stock {
    background-color: #ffe6e6 !important;
}

/* Table styling */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top:10px;
}

th, td {
    padding:8px;
    border:1px solid #ddd;
}

tr:hover {
    background-color: #f9f9f9;
}

/* Responsive */
@media (max-width:768px){
    table, th, td{
        font-size:0.8rem;
    }

    #productModal {
        top:5%;
        padding:15px;
    }
}
</style>

{% endblock %}
